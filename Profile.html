<!doctype html>
<html lang="en">
<head>
  	<meta charset="UTF-8">
	<title>Profile</title>
	<meta name=“viewport” content=“width=device-width, intitial-scale=1.0”>
	
	<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js'></script>
  	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="javascript" type="text/javascript" href="js/bootstrap.min.js">
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"> 
  	<link rel="stylesheet" href="css/login.css">

    <script src="https://cdn.firebase.com/js/client/2.4.0/firebase.js"></script>
    <script src="js/Chart.min.js"></script>
    
    <style>
        .note{
            background: #e6e6e6; 
            border-radius: 5px; 
            padding: 10px;
            margin-bottom: 15px;
        }    
        .liltable{ 
            float: left;
            padding: 20px;
            border: 1px solid lightgrey;
            border-radius: 5px; 
            height: 225px;
        }
        .liltable2{ 
            width: 45%; 
            float: left;
            padding: 20px 20px 0px 20px;
            border: 1px solid lightgrey;
            border-radius: 5px; 
            margin: 0% 1% 2% 1%;
        }
        #results_list{
            position: fixed; 
            left: 20px;
            float: left;
            width: 200px;
        }
        #display_space{
            position: relative;
            left: 220px;
        }
        .list-group-item{
            width: 100%;       
        }
        .list-group-item:focus {
            outline: none;
        }
        #patientInfo{
            float: left;
            padding: 20px;
            border: 1px solid lightgrey;
            border-radius: 5px; 
            height: 225px;
        }
        #editButton{
            position: relative;
            float: right;
            top: -60px;
        }
        #charts{
            float: left;
            padding: 20px;
            border: 1px solid lightgrey;
            border-radius: 5px; 
            height: 225px; 
            position: relative;
            top: 20px;
        }
        #profpic{
            float: left;
            margin-right: 20px;
            height: 100%;
        }
        #patientInfo p{
            float: left;
            position: relative;
            top: -60px;
            line-height: 300%;
        }
        #patientTitle{
            position: relative;
            top: -20px;
            float: left;
        }
        
        
    </style>
    
    <script>
        
        var str = location.search;
        var res = str.slice(5);
        var myDataRef = new Firebase('https://mums.firebaseio.com/' + res); 
        
        myDataRef.on('value', function(snapshot) {
            var message = snapshot.val();
            display(message.patient_fname, message.patient_lname, message.location, message.known_drug_allergies, message.medical_history);
        });
        
        function display(patient_fname, patient_lname, location, known_drug_allergies, medical_history) {
            
            $( '#patientTitle' ).text("");
            $( '#patientTitle' ).append('<h3>' + patient_fname + ' ' + patient_lname + '</h3>');
            $( '#location' ).text("");
            $( '#location' ).append("   " + location);
            $( '#known_drug_allergies' ).text("");
            $( '#known_drug_allergies' ).append("   " + known_drug_allergies);
            $( '#medical_history' ).text("");
            $( '#medical_history' ).append("   " + medical_history);
        };        
        
        function editInfo(){
            $( '#editButton' ).text("");
            $( '#editButton' ).append('<button type="button" class="btn btn-success" onclick="updateInfo()">Update</button>  <button type="button" class="btn btn-default" onclick="cancelUpdate()">Cancel</button>');
            
            $("#patientInfo p").css("line-height", "100%");
            
            myDataRef.on('value', function(snapshot) {
                var message = snapshot.val();
                $( '#location' ).text("");
                $( '#location' ).append("<textarea class='form-control' id='location_input' rows='1' cols='2' >" + message.location + "</textarea>");
                $( '#known_drug_allergies' ).text("");
                $( '#known_drug_allergies' ).append("<textarea class='form-control' id='known_drug_allergies_input' rows='1' cols='2' >" + message.known_drug_allergies + "</textarea>");
                $( '#medical_history' ).text("");
                $( '#medical_history' ).append("<textarea class='form-control' id='medical_history_input' rows='1' cols='2' >" + message.medical_history + "</textarea>"); 
            });    
        }
        
        function updateInfo(){
            $( '#editButton' ).text("");
            $( '#editButton' ).append('<button type="button" class="btn btn-default" onclick="editInfo()">Edit</button>');
            
            $("#patientInfo p").css("line-height", "300%");
            
            var location_input = $('#location_input').val();
            var known_drug_allergies_input = $('#known_drug_allergies_input').val();
            var medical_history_input = $('#medical_history_input').val();
            
            myDataRef.child("location").set(location_input);
            myDataRef.child("known_drug_allergies").set(known_drug_allergies_input);
            myDataRef.child("medical_history").set(medical_history_input);
            
            $( '#location' ).text("   " + location_input);
            $( '#known_drug_allergies' ).text("   " + known_drug_allergies_input);
            $( '#medical_history' ).text("   " + medical_history_input);
        }
        
        function cancelUpdate(){
            $( '#editButton' ).text("");
            $( '#editButton' ).append('<button type="button" class="btn btn-default" onclick="editInfo()">Edit</button>');
            
            $("#patientInfo p").css("line-height", "300%");
            
            myDataRef.on('value', function(snapshot) {
                var message = snapshot.val();

                $( '#location' ).text("   " + message.location);
                $( '#known_drug_allergies' ).text("   " + message.known_drug_allergies);
                $( '#medical_history' ).text("   " + message.medical_history);
            });
        }

        var DateRef = myDataRef.child("/tests");
        var key;
        DateRef.orderByChild("timeRef").on('child_added', function(snapshot) {
            var message = snapshot.val();
            key = snapshot.key();
            
            $( '#results_list').append(
                '<button type="button" class="list-group-item" id="button' + key + '" onclick=resultsTable("'+ key +'")> ' + message.timeStamp + '</button>'
            );

        });
   
        function getTimestamp(){
            var date = new Date();
            currentDate = date.getDate();  
            month = date.getMonth() + 1; 
            year = date.getFullYear();
            hour = date.getHours();
            min = date.getMinutes();
            sec = date.getSeconds();
            return (month + "/" + currentDate + "/" + year + "  " + hour + ":" + min + ":" + sec);
        }

        function loadOverview() {
            
            var lastTestRef = myDataRef.child("lastTestRef");
            lastTestRef.on('value', function(snapshot) {
                var testMessage = snapshot.val();
                $( '#tableTitle').text("Results for: " + testMessage.timeStamp);
                $( '#pH' ).text(testMessage.pH);
                $( '#nitrite' ).text(testMessage.nitrite);
                $( '#ketone' ).text(testMessage.ketone);
                $( '#glucose' ).text(testMessage.glucose);
            });
            
        };
        
        function resultsTable (key) {           
            var tableRef = DateRef.child(key);
            tableRef.on('value', function(snapshot) {
                var message = snapshot.val();
                
                var checkColor = $('#button' + key).css("background-color");
                if(checkColor == "rgb(245, 245, 245)" || checkColor == "rgb(255, 255, 255)"){
                    $( '#button' + key ).css("background-color","rgb(128, 128, 128)");
                    $( '#button' + key ).css("color","white");
            
                    $( '#display_space' ).append('<div id="table' + key + '" class="liltable2"><b>' + message.timeStamp + '</b><table class="table table-striped"><tbody><tr><td>pH</td><td>' + message.pH + '</td></tr><tr><td>Nitrite</td><td>' + message.nitrite + '</td></tr><tr><td>Ketone</td><td>' + message.ketone + '</td></tr><tr><td>Glucose</td><td>' + message.glucose + '</td></tr></tbody></table></div>');
                }
                else if(checkColor == "rgb(128, 128, 128)"){
                    $( '#button' + key ).css("background-color","rgb(255, 255, 255)");
                    $( '#button' + key ).css("color","black");
                    $('#table' + key).remove();
                }
            });    
        };

    function addNote(){
        var timeStamp = getTimestamp();   
        var note = $('#noteField').val();
        $("#noteField").val("");
            
        var noteRef = myDataRef.child("notes");
        noteRef.push({timeStamp: timeStamp, note: note});
        myDataRef.child("lastNoteRef").set({timeStamp: timeStamp, note: note});
        loadOverview();
    }
        
    function loadNotes(){
        $('#pastNotes').text("");
        
        var noteRef = myDataRef.child("notes");
        noteRef.on('child_added', function(snapshot) {
            var message = snapshot.val();
            var key = snapshot.key();
            $('#pastNotes').prepend("<div id='" + key + "'class='note'><h4>" + message.timeStamp + "        <span class='glyphicon glyphicon-trash' style='float:right' onclick='deleteNote(" + '"' + key + '"' + ")'> </h4>" + message.note + "</span></div>");  
        }); 
        
    }    
        
    function deleteNote(key){    
        var noteKeyRef = myDataRef.child("notes/" + key);
        noteKeyRef.remove();
        $("#" + key).remove();
        loadOverview();
    }
        
    </script>

</head>

<body onload="loadOverview()">
	<!--enabling tabs-->	
	<script language="javascript">
		$('#myTabs a').click(function (e) {
		  e.preventDefault()
		  $(this).tab('show')
		})

		$('#myTabs a[href="#profile"]').tab('show') // Select tab by name
		$('#myTabs a:first').tab('show') // Select first tab
		$('#myTabs a:last').tab('show') // Select last tab
		$('#myTabs li:eq(2) a').tab('show') // Select third tab (0-indexed)

		$('#someTab').tab('show')
		
		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
		  e.target // newly activated tab
		  e.relatedTarget // previous active tab
		})
	</script>
	<!--end enabling tabs-->
	
	<!--Horizontal Nav Bar at Top, credit to http://www.bootply.com/98314-->
		<nav class="navbar navbar-default" role="navigation">
		  <div class="navbar-header">
		    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		      <span class="icon-bar"></span>
		      <span class="icon-bar"></span>
		      <span class="icon-bar"></span>
		    </button>    
		  </div>
		  <a class="navbar-brand" href="#">MUMS</a>
		  <div class="navbar-collapse collapse">
		    <ul class="nav navbar-nav navbar-right">
		      <li>
		      	<a href="testSetUp.html">
		      		<span class="glyphicon glyphicon-camera" aria-hidden="true"></span> Start New Test</a>
		      	
		      </li>
		      <li><a href="Dashboard.html"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Back To Database</a>
		      </li>
		    </ul>
		  </div>
		</nav>
	<!--end nav bar-->

	<!--tab header-->
	<ul id="mainTabs" style="margin-bottom:20px;" class="nav nav-tabs">
	  <li class="active"><a data-toggle="tab" href="#home">Overview</a></li>
	  <li><a data-toggle="tab" href="#results">Results</a></li>
	  <li><a data-toggle="tab" href="#notes" onclick="loadNotes()">Notes</a></li>
	</ul>
	<!--end tab header-->

	<div class="tab-content">
		  <div id="home" class="tab-pane fade in active">
		  
			<div class="container">

			            
			          <div id="main">  
                            <div id="patientInfo"  class="col-sm-6">
                                <img id="profpic" src="img/default_profpic-01.png" alt="Default Profile Picture">
                                <span id="patientTitle"></span>
                                <p><br>Location:<b><span id="location"></span></b>
                                <br>Known Drug Allergies:<b><span id="known_drug_allergies"></span></b>
                                <br>Medical History:<b><span id="medical_history"></span></b></p>
                                <div id="editButton"><button type="button" class="btn btn-default" onclick="editInfo()">Edit</button></div>
			                 </div> 
                                
			            
			                 <div id="spacer" class="col-sm-1"></div>
			                <div id="recentLevels" class="col-sm-5 liltable">
                                
                                        <b id="tableTitle"></b>
					                    <table id="overviewTable" class="table table-striped">
										    <tbody>
										      <tr>
										        <td>pH</td>
										        <td id="pH"></td>
										       
										      </tr>
										      <tr>
										        <td>Nitrite</td>
										        <td id="nitrite"></td>
										    
										      </tr>
										      <tr>
										        <td>Ketone</td>
										        <td id="ketone"></td>
										       
										      </tr>
										      <tr>								
										        <td>Glucose</td>
										        <td id="glucose"></td>
										   
										      </tr>
										    </tbody>
										</table>
		                       
			               			 </div><!--end results table-->
			               			 <div id="spacer" class="col-sm-1"></div>
                                    
                                    <div id="charts" class="col-sm-12">    
                                        <canvas id="ketonesChart" width="200" height="200"></canvas>
                                        <canvas id="nitritesChart" width="200" height="200"></canvas>
                                        <canvas id="glucoseChart" width="200" height="200"></canvas>
                                        <canvas id="pHChart" width="200" height="200"></canvas>
                                    </div>
			                
			            </div>
                


                    <!--end secondary-->
			            
			</div><!--end container div-->






		 </div><!--end home tab-->



<div id="results" class="tab-pane fade">

                                <div id="results_list" class="panel panel-default">
                                    <div class="panel-heading"><h5>Select the date(s) below<br>to view past results:</h5></div>
                                    <!--generate list items here-->
                                </div>
                                
                                <div id="display_space" class="col-sm-9">
                                    <!--generate selected items here-->
                                </div> 
                            
    
    
</div><!--end results tab-->



<div id="notes" class="tab-pane fade">
		    
	<div class="container">
        <textarea class="form-control" rows="5" id="noteField" placeholder="Add a note..."></textarea>
        <br>
        <button type="button" class="btn btn-success" onclick="addNote()">Add Note</button>
        <br>
        <br>
        <div id="pastNotes"></div>
    </div>

</div><!--end notes tab div-->

<script>
        /////////CHART STUFF////////////     
var testx = "2/12/2016";
  var testy = "7";

  //ketones chart data
      var ketonesData = {
          
          labels: [testx, testx, testx, "April", "May", "June", "July"],
          datasets: [
              {
                  label: "Ketones",
                  fillColor: "rgba(151,187,205,0.2)",
                  strokeColor: "rgba(151,187,205,1)",
                  pointColor: "rgba(151,187,205,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(151,187,205,1)",
                  data: [6, 6.5, 7, 7.5, , testy, 8]
              }              
          ]
      }

  //Nitrites Chart Data
      var nitritesData = {       
          labels: [testx, testx, testx, "April", "May", "June", "July"],
          datasets: [
              {
                  label: "Nitrites",
                  fillColor: "rgba(220,220,220,0.5)",
                  strokeColor: "rgba(220,220,220,0.8)",
                  highlightFill: "rgba(220,220,220,0.75)",
                  highlightStroke: "rgba(220,220,220,1)",
                  data: [0, 0, 128, 0, 0, 0, 32]
              }             
          ]
      }



  //Glucose Chart Data
      var glucoseData = {
          
          labels: [testx, testx, testx, "April", "May", "June", "July"],
          datasets: [
              {
                  label: "Glucose",
                  fillColor: "rgba(151,187,205,0.2)",
                  strokeColor: "rgba(151,187,205,1)",
                  pointColor: "rgba(151,187,205,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(151,187,205,1)",
                  data: [0, 0, 5, 30, 60, 110, 0]
              }              
          ]
      }

  //pH Chart Data
      var pHData = {
          
          labels: [testx, testx, testx, "April", "May", "June", "July"],
          datasets: [
              {
                  label: "pH",
                  fillColor: "rgba(151,187,205,0.2)",
                  strokeColor: "rgba(151,187,205,1)",
                  pointColor: "rgba(151,187,205,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(151,187,205,1)",
                  data: [5, 6.5, 7, 7.5, , testy, 8.5]
              }              
          ]
      }

      
      
      // Get the context of the canvas elements we want to select
      var Kctx = document.getElementById("ketonesChart").getContext("2d");
      var Nctx = document.getElementById("nitritesChart").getContext("2d");
      var Gctx = document.getElementById("glucoseChart").getContext("2d");
      var Pctx = document.getElementById("pHChart").getContext("2d");
      
      //generate chart
      var myKetonesChart = new Chart(Kctx).Line(ketonesData);
      var myNitritesChart = new Chart(Nctx).Bar(nitritesData);
      var myGlucoseChart = new Chart(Gctx).Line(glucoseData);
      var mypHChart = new Chart(Pctx).Line(pHData);
      
    ////////END CHART STUFF////////  
</script>


</body>
</html>